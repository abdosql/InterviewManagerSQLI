{# @var ea \EasyCorp\Bundle\EasyAdminBundle\Context\AdminContext #}
{# @var entity \EasyCorp\Bundle\EasyAdminBundle\Dto\EntityDto #}
{% extends ea.templatePath('layout') %}

{% block body_id 'ea-detail-' ~ entity.name ~ '-' ~ entity.primaryKeyValue %}
{% block body_class 'ea-detail ea-detail-' ~ entity.name %}

{% set ea_field_assets = ea.crud.fieldAssets(constant('EasyCorp\\Bundle\\EasyAdminBundle\\Config\\Crud::PAGE_DETAIL')) %}

{% block configured_head_contents %}
    {{ parent() }}
    {% for htmlContent in ea_field_assets.headContents %}
        {{ htmlContent|raw }}
    {% endfor %}
{% endblock %}

{% block configured_body_contents %}
    {{ parent() }}
    {% for htmlContent in ea_field_assets.bodyContents %}
        {{ htmlContent|raw }}
    {% endfor %}
{% endblock %}

{% block configured_stylesheets %}
    {{ parent() }}
    <link href="https://cdn.jsdelivr.net/npm/froala-editor@latest/css/froala_editor.pkgd.min.css" rel="stylesheet" type="text/css" />
    {{ include('@EasyAdmin/includes/_css_assets.html.twig', { assets: ea_field_assets.cssAssets }, with_context = false) }}
    {{ include('@EasyAdmin/includes/_encore_link_tags.html.twig', { assets: ea_field_assets.webpackEncoreAssets }, with_context = false) }}
{% endblock %}

{% block configured_javascripts %}
    {{ parent() }}

    {{ include('@EasyAdmin/includes/_js_assets.html.twig', { assets: ea_field_assets.jsAssets }, with_context = false) }}
    {{ include('@EasyAdmin/includes/_encore_script_tags.html.twig', { assets: ea_field_assets.webpackEncoreAssets }, with_context = false) }}
{% endblock %}

{% block content_title %}
    {%- apply spaceless -%}
        {% set custom_page_title = ea.crud.customPageTitle(pageName, entity ? entity.instance : null, ea.i18n.translationParameters) %}
        {{ custom_page_title is null
        ? ea.crud.defaultPageTitle(null, null, ea.i18n.translationParameters)|trans|raw
        : custom_page_title|trans|raw }}
    {%- endapply -%}
{% endblock %}

{% block page_actions %}
    {% for action in entity.actions %}
        {{ include(action.templatePath, { action: action }, with_context = false) }}
    {% endfor %}
{% endblock %}

{% block main %}
    <div class="detail-view">
        <table class="table">
            <tbody>
            {% for field in entity.fields %}
                {% if field.isFormLayoutField %}
                    {{ _self.render_layout_field(field) }}
                {% else %}
                    <tr>
                        <th>{{ field.label|trans|raw }}</th>
                        <td>{{ include(field.templatePath, { field: field, entity: entity }, with_context = false) }}</td>
                    </tr>
                {% endif %}
            {% endfor %}
            </tbody>
        </table>
        {% set interview = entity.getInstance() %}
        {% set interviewDate = interview.getInterviewDate() | date("Y-m-d") %}
        {% set currentDate = "now" | date("Y-m-d") %}
        {% set latestStatus = interview.getInterviewStatuses()|last %}
        {% set isInProgress = latestStatus and latestStatus.status == 'IN_PROGRESS' %}
        <div class="accordion accordion-flush pb-3" id="notesAccordion">
            <div class="accordion-item">
                <div class="accordion-header p-0" id="notesHeader">
                    <span>
                        <button style="padding: 2px 20px" class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#notesCollapse" aria-expanded="false" aria-controls="notesCollapse">
                            <i class="fas fa-clipboard-list me-2"></i> Interview Notes
                            <p style="font-size: small" class="text-muted text-sm-start m-3"><small><i class="fas fa-info-circle me-1"></i> Click the header to toggle content visibility.</small></p>
                        </button>
                    </span>
                </div>
                <div id="notesCollapse" class="accordion-collapse collapse" aria-labelledby="notesHeader" data-bs-parent="#notesAccordion">
                    <div class="accordion-body">
                        <ul id="appreciationsList" class="list-group">
                            <!-- Appreciations will be dynamically inserted here -->
                        </ul>
                    </div>
                </div>
            </div>
        </div>


        {% if is_granted("ROLE_EVALUATOR") and not is_granted("ROLE_HR_MANAGER") %}

            <span class="d-inline-block" tabindex="0" data-bs-toggle="tooltip"
                  title="{% if isInProgress %}Interview is already in progress{% else %}Click to start the interview{% endif %}"
                  data-bs-placement="top" data-bs-custom-class="custom-tooltip">
                {% if latestStatus and latestStatus.getStatus() == "SCHEDULED" and interviewDate == currentDate %}
                    <button id="show-editor" class="btn btn-primary mt-3 mb-3"
                        {% if isInProgress %}
                            disabled
                        {% endif %}>
                        Start Interview
                    </button>
                {% elseif isInProgress %}
                    <button id="show-editor" class="btn btn-primary mt-3 mb-3"
                        {% if isInProgress %}
                            disabled
                        {% endif %}>
                        Start Interview
                    </button>
                {% elseif latestStatus and latestStatus.getStatus() == "IS_PASSED" %}
                    <span class="badge badge-success p-2" style="font-size: 1rem">Interview Done, Candidate Passed !</span>
                {% elseif latestStatus and latestStatus.getStatus() == "IS_FAILED" %}
                    <span class="badge badge-danger p-2" style="font-size: 1rem">Interview Done, Candidate Failed !</span>
                {% endif %}
            </span>


            <div id="save-indicator" style="
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: #4CAF50;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                font-family: Arial, sans-serif;
                font-size: 16px;
                opacity: 0;
                transform: translateY(-20px);
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                z-index: 9999;">
                Saved!
            </div>
{% else %}
    <div class="interview-timeline mb-4">
        <h4 class="mb-3">Interview Timeline</h4>
        <ul class="list-unstyled">
            {% set statuses = [
                {name: 'SCHEDULED', icon: 'fa-clock', variant: 'secondary'},
                {name: 'IN_PROGRESS', icon: 'fa-play', variant: 'info'},
                {name: 'IS_PASSED', icon: 'fa-check', variant: 'success'},
                {name: 'IS_FAILED', icon: 'fa-times', variant: 'danger'}
            ] %}
            
            {% set currentStatus = latestStatus ? latestStatus.getStatus()|upper : 'SCHEDULED' %}
            {% set currentStatusInfo = statuses|filter(s => s.name == currentStatus)|first %}

            <li class="d-flex justify-content-between align-items-center mb-3">
                {% for status in statuses %}
                    {% set isCurrentStatus = status.name == currentStatus %}
                    <div class="text-center position-relative">
                        <div class="rounded-circle {% if isCurrentStatus %}bg-{{ status.variant }} text-white{% else %}bg-light text-{{ status.variant }}{% endif %} d-inline-flex justify-content-center align-items-center" style="width: 50px; height: 50px; border: 2px solid {% if isCurrentStatus %}#{{ status.variant }}{% else %}#ccc{% endif %}; transition: all 0.3s ease;">
                            <i class="fas {{ status.icon }} {% if isCurrentStatus %}fa-lg{% endif %}"></i>
                        </div>
                        <p class="mt-2 mb-0 small {% if isCurrentStatus %}font-weight-bold{% endif %}">{{ status.name|replace({'_': ' '})|capitalize }}</p>
                        {% if isCurrentStatus %}
                            <div class="position-absolute" style="top: -10px; right: -10px;">
                                <span class="badge bg-{{ status.variant }} p-2" style="font-size: 0.7rem;">
                                    Current
                                </span>
                            </div>
                        {% endif %}
                    </div>
                    {% if not loop.last %}
                        <div class="flex-grow-1 {% if loop.index0 < statuses|filter(s => s.name == currentStatus)|first.name|length %}bg-{{ currentStatusInfo.variant }}{% else %}bg-secondary{% endif %}" style="height: 3px; transition: all 0.3s ease;"></div>
                    {% endif %}
                {% endfor %}
            </li>
        </ul>
        
        <div class="text-center mt-4">
            <h5>Current Status:</h5>
            {% if currentStatusInfo %}
                <span class="badge bg-{{ currentStatusInfo.variant }} p-2" style="font-size: 1.2rem;">
                    {{ currentStatus|replace({'_': ' '})|capitalize }}
                </span>
            {% else %}
                <span class="badge bg-secondary p-2" style="font-size: 1.2rem;">
                    Unknown Status
                </span>
            {% endif %}
        </div>
    </div>
{% endif %}
        {% block delete_form %}
            {{ include('@EasyAdmin/crud/includes/_delete_form.html.twig', { entity_id: entity.primaryKeyValue }, with_context = false) }}
        {% endblock delete_form %}
    </div>
    <input id="interviewId" value="{{ entity.primaryKeyValue }}" type="hidden"/>

    {% if is_granted("ROLE_EVALUATOR") and not is_granted("ROLE_HR_MANAGER")%}
        <div id="froala-editor-container"  class="froala-editor-container w-100"
                {% if not isInProgress %}
                    style="display:none">
                {% endif %}

            <fieldset class="form-fieldset">
                <legend>Interview Notes</legend>
            </fieldset>
            {{ form_start(froalaForm) }}
            {{ form_widget(froalaForm) }}
            <button  id="save-notes" class="btn btn-md btn-danger">Add Note</button>

            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="mt-3">
                        <a id="reformulate" class="btn btn-md btn-success">Reformulate with AI</a>
                    </div>
                </div>
                <div>
                    <div class="mt-3">
                        <a id="accept-interview" class="btn btn-primary">Accept</a>
                        <a id="reject-interview" class="btn btn-danger">Reject</a>
                    </div>
                </div>
            </div>
            {{ form_end(froalaForm) }}
        </div>
    {% endif %}
{% endblock %}

{% block body_javascript %}
    {{ parent() }}

    {{ encore_entry_script_tags('app') }}
    {{ encore_entry_script_tags('appreciation') }}

{% endblock %}
{% macro render_field_contents(entity, field) %}
    <div class="field-group {{ field.cssClass }}">
        {% if field.label is same as (false) %}
            {# a FALSE label value means that the field doesn't even display the <label> element;
               use an empty string to not display a label but keep the <label> element to not mess with the layout #}
        {% else %}
            <div class="field-label">
                {%- set label_html_attributes -%}
                    {%- if field.help is not empty -%}
                        data-bs-toggle="tooltip" data-bs-placement="auto" data-bs-animation="false"
                        data-bs-html="true" data-bs-custom-class="ea-detail-label-tooltip"
                        data-bs-title="{{ field.help|trans|e('html_attr') }}"
                    {%- endif -%}
                {%- endset -%}

                <div {{ label_html_attributes }}>
                    {{ field.label|trans|raw }}
                </div>
            </div>
        {% endif %}

        <div class="field-value">
            {{ include(field.templatePath, { field: field, entity: entity }, with_context = false) }}
        </div>
    </div>
{% endmacro %}

{% macro render_layout_field(field) %}
    {% if field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormTabListType' %}
        {{ _self.render_tab_list(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormTabPaneGroupOpenType' %}
        {{ _self.render_tab_group_open(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormTabPaneGroupCloseType' %}
        {{ _self.render_tab_group_close(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormTabPaneOpenType' %}
        {{ _self.render_tab_open(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormTabPaneCloseType' %}
        {{ _self.render_tab_close(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormColumnGroupOpenType' %}
        {{ _self.render_column_group_open(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormColumnGroupCloseType' %}
        {{ _self.render_column_group_close(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormColumnOpenType' %}
        {{ _self.render_column_open(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormColumnCloseType' %}
        {{ _self.render_column_close(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormFieldsetOpenType' %}
        {{ _self.render_fieldset_open(field) }}
    {% elseif field.formType == 'EasyCorp\\Bundle\\EasyAdminBundle\\Form\\Type\\Layout\\EaFormFieldsetCloseType' %}
        {{ _self.render_fieldset_close(field) }}
    {% endif %}
{% endmacro %}

{% macro render_tab_list(field) %}
    {% set tab_id_option_name = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Field\\FormField::OPTION_TAB_ID') %}
    {% set tab_is_active_option_name = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Field\\FormField::OPTION_TAB_IS_ACTIVE') %}
    {% set tab_error_count_option_name = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Field\\FormField::OPTION_TAB_ERROR_COUNT') %}

    <div class="nav-tabs-custom form-tabs-tablist">
        <ul class="nav nav-tabs">
            {% for tab in field.getCustomOption('tabs') %}
                <li class="nav-item">
                    <a class="nav-link {% if tab.getCustomOption(tab_is_active_option_name) %}active{% endif %}" href="#{{ tab.getCustomOption(tab_id_option_name) }}" id="tablist-{{ tab.getCustomOption(tab_id_option_name) }}" data-bs-toggle="tab">
                        {%- if tab.getCustomOption('icon')|default(false) -%}
                            <i class="tab-nav-item-icon fa-fw {{ tab.getCustomOption('icon') }}"></i>
                        {%- endif -%}
                        {{ tab.label|trans(domain = ea.i18n.translationDomain)|raw }}

                        {% set tab_error_count = tab.getCustomOption(tab_error_count_option_name) %}
                        {%- if tab_error_count > 0 -%}
                            <span class="badge badge-danger" title="{{ 'form.tab.error_badge_title'|trans({'%count%': tab_error_count}, 'EasyAdminBundle') }}">
                                {{- tab_error_count -}}
                            </span>
                        {%- endif -%}
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>
{% endmacro %}

{% macro render_tab_group_open(field) %}
<div class="nav-tabs-custom form-tabs-content">
    <div class="tab-content">
        {% endmacro %}

        {% macro render_tab_group_close(field) %}
    </div>
</div>
{% endmacro %}

{% macro render_tab_open(field) %}
    {% set tab_id_option_name = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Field\\FormField::OPTION_TAB_ID') %}
    {% set tab_is_active_option_name = constant('EasyCorp\\Bundle\\EasyAdminBundle\\Field\\FormField::OPTION_TAB_IS_ACTIVE') %}

    <div id="{{ field.getCustomOption(tab_id_option_name) }}" class="tab-pane {% if field.getCustomOption(tab_is_active_option_name) %}active{% endif %} {{ field.cssClass }}" {% for key, value in field.getFormTypeOption('attr') %}{{ key }}="{{ value|e('html_attr') }}"{% endfor %}>
    {% if field.help %}
        <div class="content-header-help tab-help">
            {{ field.help|trans|raw }}
        </div>
    {% endif %}
{% endmacro %}

{% macro render_tab_close(field) %}
    </div>
{% endmacro %}

{% macro render_column_group_open(field) %}
<div class="form-row">
    {% endmacro %}

    {% macro render_column_group_close(field) %}
</div>
{% endmacro %}

{% macro render_column_open(field) %}
<div class="form-group col-md-{{ field.getCustomOption('width') }}">
    {% endmacro %}

    {% macro render_column_close(field) %}
</div>
{% endmacro %}

{% macro render_fieldset_open(field) %}
<fieldset class="form-fieldset">
    <legend>{{ field.label|trans|raw }}</legend>
    {% endmacro %}

    {% macro render_fieldset_close(field) %}
</fieldset>
{% endmacro %}
